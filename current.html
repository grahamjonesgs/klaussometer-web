<!DOCTYPE html>
<html>

<head>
    <title>Home Stats</title>
    <style type="text/css">
        .nav-button {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px;
            background-color: #007bff;
            color: white;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .nav-button:hover {
            background-color: #0056b3;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #eef2f5;
            padding: 20px;
        }

        .dashboard-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .room-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            min-width: 250px;
            flex: 1;
        }

        .room-card h2 {
            margin: 0 0 10px;
            font-size: 1.5rem;
            color: #333;
        }

        .value-display { /* A common class for the values */
            display: inline-block;
        }

        .temp-value,
        .humidity-value {
            font-size: 3rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .humidity-value {
            color: #28a745;
        }

        .unit {
            font-size: 1.5rem;
            font-weight: normal;
            color: #666;
            margin-left: 5px;
        }

        /* --- New CSS for Flashing Effect --- */
        @keyframes flash-animation {
            0% { background-color: transparent; }
            50% { background-color: yellow; } /* Flash color */
            100% { background-color: transparent; }
        }

        .flash-temp {
            animation: flash-animation 1s ease-out 3; /* Flash 3 times over 1 second */
            border-radius: 4px;
        }
        
        .flash-humidity {
            animation: flash-animation 1s ease-out 3; 
            border-radius: 4px;
        }
        /* ---------------------------------- */


        @media (max-width: 768px) {
            .room-card {
                min-width: 150px;
            }

            .temp-value,
            .humidity-value {
                font-size: 2rem;
            }

            .unit {
                font-size: 1rem;
            }
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script src="../js/config.js"></script> 

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

</head>

<body>
    <a href="graph.html" class="nav-button">View Graph</a>
    <div id="dashboard-container" class="dashboard-container">
    </div>

    

    <p id="last-updated-time" style="text-align: center; font-style: italic; color: #666;"></p>

    <script>
        // Store the previous data to compare against
        let previousRoomData = {}; 

        $(document).ready(function() {
            // Run the function once immediately
            showCurrent();
            
            // Then, set it to run every 30 seconds
            setInterval(showCurrent, 30000);
        });

        function showCurrent() {
            $.get("latest.php", function(data) {
                var dataJSON = JSON.parse(data);
                var currentRoomData = {};

                if (dataJSON.length > 0) {
                    
                    dataJSON.forEach(function(item) {
                        var room_id = item.room_id;
                        var type = item.type;
                        var value = item.value;

                        if (!currentRoomData[room_id]) {
                            currentRoomData[room_id] = {
                                temp: '--',
                                humidity: '--'
                            };
                        }
                        
                        if (type === 'tempset-ambient') {
                            currentRoomData[room_id].temp = parseFloat(value).toFixed(1);
                        } else if (type === 'tempset-humidity') {
                            currentRoomData[room_id].humidity = parseFloat(value).toFixed(0);
                        }
                    });

                    var dashboardContainer = $('#dashboard-container');
                    dashboardContainer.empty();

                    for (var room_id in currentRoomData) {
                        if (currentRoomData.hasOwnProperty(room_id)) {
                            var displayName = (typeof roomMap !== 'undefined' && roomMap[room_id]) ? roomMap[room_id] : room_id;

                            const newTemp = currentRoomData[room_id].temp;
                            const newHumidity = currentRoomData[room_id].humidity;
                            const oldTemp = previousRoomData[room_id] ? previousRoomData[room_id].temp : null;
                            const oldHumidity = previousRoomData[room_id] ? previousRoomData[room_id].humidity : null;

                            const tempClass = (newTemp !== oldTemp && oldTemp !== null) ? 'flash-temp' : '';
                            const humidityClass = (newHumidity !== oldHumidity && oldHumidity !== null) ? 'flash-humidity' : '';

                            var $card = $('<div>')
                                .addClass('room-card')
                                .attr('data-room-id', room_id);

                            var $title = $('<h2>').text(displayName);

                            var $tempPara = $('<p>');
                            var $tempValue = $('<span>')
                                .addClass('value-display temp-value ' + tempClass)
                                .attr('id', 'temp-' + room_id)
                                .text(newTemp);
                            var $tempUnit = $('<span>').addClass('unit').html('&#8451;');
                            $tempPara.append($tempValue, $tempUnit);

                            var $humidityPara = $('<p>');
                            var $humidityValue = $('<span>')
                                .addClass('value-display humidity-value ' + humidityClass)
                                .attr('id', 'humidity-' + room_id)
                                .text(newHumidity);
                            var $humidityUnit = $('<span>').addClass('unit').text('%');
                            $humidityPara.append($humidityValue, $humidityUnit);

                            $card.append($title, $tempPara, $humidityPara);
                            dashboardContainer.append($card);
                                                    }
                                                }

                    previousRoomData = currentRoomData;
                    
                    setTimeout(() => {
                        $('.flash-temp, .flash-humidity').removeClass('flash-temp flash-humidity');
                    }, 3000);

                    var now = new Date();
                    var timeString = now.toLocaleTimeString();
                    document.getElementById('last-updated-time').textContent = 'Last updated: ' + timeString;

                } else {
                    console.log("No data returned from server.");
                    document.getElementById('last-updated-time').textContent = 'Last updated: ' + new Date().toLocaleTimeString() + ' (No data)';
                }
            });
        }
    </script>
</body>
</html>